<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Authored — Start</title>

  <link rel="icon" href="data:,">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./account.js" defer></script>
  <script src="./auth-guard.js" defer></script>

  <style>
    body { font-family: Arial, sans-serif; margin:48px; max-width:900px; }
    h1,h2,h3 { margin-bottom:8px; }
    p { color:#333; line-height:1.5; }
    label { font-weight:700; margin-top:14px; display:block; }
    textarea,input,select { width:100%; padding:10px; margin-top:6px; }
    textarea { min-height:90px; }
    button { padding:10px 14px; border-radius:6px; cursor:pointer; }
    .btn { background:#000; color:#fff; border:none; }
    .btn.secondary { background:#fff; color:#000; border:1px solid #000; }
    .notice { background:#fff7d6; border:1px solid #f2d27a; padding:12px; margin:14px 0; }
    .card { border:1px solid #ddd; border-radius:10px; padding:16px; margin-top:14px; }
    pre { white-space:pre-wrap; background:#fafafa; padding:12px; border-radius:8px; }
  </style>
</head>

<body>
<h1>Start your book</h1>
<p class="muted">Authored writes with you, not for you.</p>

<div class="notice">
  <strong>Free plan:</strong>
  1 introduction + 2 chapter expansions.
</div>

<label>What are you writing about?</label>
<textarea id="topic"></textarea>

<label>Who is this for?</label>
<input id="audience" />

<label>Your writing sample (optional)</label>
<textarea id="voiceSample"></textarea>

<button class="btn" id="beginBtn">Generate outline</button>

<div id="result" style="display:none;">
  <div class="card">
    <h2 id="titleOut"></h2>
    <p id="purposeOut"></p>
    <ol id="outlineOut"></ol>

    <button class="btn secondary" id="regenOutlineBtn">Regenerate outline</button>
  </div>

  <div class="card">
    <h3>Introduction</h3>
    <button class="btn secondary" id="genIntroBtn">Generate introduction</button>
    <pre id="introOut"></pre>
  </div>

  <div class="card">
    <h3>Expand chapter</h3>
    <select id="chapterPick"></select>
    <button class="btn" id="expandBtn">Expand</button>
    <pre id="expandedOut"></pre>
  </div>
</div>

<script>
/* ---------------- LIMIT TRACKING (SAFE, LOCAL) ---------------- */

const LIMITS = {
  intro: 1,
  expand: 2
};

function getUsage(key) {
  return Number(localStorage.getItem(key) || 0);
}
function incUsage(key) {
  localStorage.setItem(key, getUsage(key) + 1);
}
function blocked(key) {
  return getUsage(key) >= LIMITS[key];
}

function upgradePrompt() {
  alert(
    "You’ve reached the free limit.\n\n" +
    "Upgrade to continue writing:\n" +
    "$49 per book or $149 lifetime."
  );
}

/* ---------------- OUTLINE ---------------- */

document.getElementById("beginBtn").onclick = async () => {
  const topic = topicEl.value.trim();
  if (!topic) return alert("Enter a topic");

  const res = await fetch("/api/outline", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      topic,
      audience:audienceEl.value,
      voiceSample:voiceSample.value
    })
  });

  const data = await res.json();
  if (!res.ok) return alert(data.error || "Failed");

  window.__outline = data.outline;
  titleOut.textContent = data.title;
  purposeOut.textContent = data.purpose;

  outlineOut.innerHTML = "";
  chapterPick.innerHTML = "";

  data.outline.forEach((c,i)=>{
    const li=document.createElement("li");
    li.textContent=c.title;
    outlineOut.appendChild(li);

    const opt=document.createElement("option");
    opt.value=i;
    opt.textContent=`Chapter ${i+1}: ${c.title}`;
    chapterPick.appendChild(opt);
  });

  result.style.display="block";
};

/* ---------------- INTRODUCTION ---------------- */

genIntroBtn.onclick = async () => {
  if (blocked("intro")) return upgradePrompt();

  introOut.textContent="Generating...";
  const res = await fetch("/api/intro",{ method:"POST" });
  const data = await res.json();

  if (!res.ok) {
    if (data.error==="limit_reached") return upgradePrompt();
    return alert("Intro failed");
  }

  incUsage("intro");
  introOut.textContent=data.introduction;
};

/* ---------------- EXPAND ---------------- */

expandBtn.onclick = async () => {
  if (blocked("expand")) return upgradePrompt();

  const idx = Number(chapterPick.value);
  const chapter = window.__outline[idx];

  expandedOut.textContent="Expanding...";
  const res = await fetch("/api/expand",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ chapterTitle:chapter.title })
  });

  const data = await res.json();

  if (!res.ok) {
    if (data.error==="limit_reached") return upgradePrompt();
    return alert("Expansion failed");
  }

  incUsage("expand");
  expandedOut.textContent=data.expanded;
};
</script>
</body>
</html>
